/*
 * Copyright (C) 2016 phantombot.tv
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */

/* 
 * @author IllusionaryOne
 */

/*
 * modulesPanel.js
 * Drives the Modules Panel
 */
(function() {

    /*
     * onMessage
     * This event is generated by the connection (WebSocket) object.
     */
    function onMessage(message) {
        var msgObject;

        try {
            msgObject = JSON.parse(message.data);
        } catch (ex) {
            return;
        }

        // Check for dbkeysresult queries
        if (panelHasQuery(msgObject)) {
            var module = "",
                moduleEnabled = "",
                html = "<table>",
                pill = "";

            if (panelCheckQuery(msgObject, 'modules_modules')) {
                for (idx in msgObject['results']) {
                    module = msgObject['results'][idx]['key'];
                    moduleEnabled = msgObject['results'][idx]['value'];
                    if (module.indexOf('/core/') === -1 && module.indexOf('/lang/') === -1) {
                        if (panelMatch(moduleEnabled, 'true')) {
                            pill = "<span class=\"greenPill-sm\">Enabled&nbsp;</span>";
                        } else {
                            pill = "<span class=\"redPill-sm\">Disabled</span>";
                        }
                        html += "<tr><td><div id=\"moduleStatus_" + idx + "\" class=\"textList\" style=\"padding: 2px\">" + pill + "</div></td>" +
                                "<td><div class=\"textList\" style=\"padding: 2px\">" + module + "</div></td>" +
                                "<td><button type=\"button\" class=\"btn btn-danger btn-xs pull-right\" onclick=\"$.disableModule('" + module + "', " + idx + ")\">Disable</button>" +
                                "<button type=\"button\" class=\"btn btn-success btn-xs pull-right\" onclick=\"$.enableModule('" + module + "', " + idx + ")\">Enable</button></td>" +
                                "</tr>";
                    }
                }
                html += "</table>";
                $("#modulesList").html(html);
            }
        }
    }

    /**
     * @function doQuery
     */
    function doQuery() {
        sendDBKeys("modules_modules", "modules");
    }

    /** 
     * @function enableModule
     * @param {String} module
     */
    function enableModule(module, idx) {
        $("#moduleStatus_" + idx).html("<i style=\"color: #6136b1\" class=\"fa fa-spinner fa-spin\" />");
        sendCommand("module enable " + module);
        setTimeout(function() { doQuery(); }, 1000);
    }

    /**
     * @function disableModule
     * @param {String} module
     */
    function disableModule(module, idx) {
        $("#moduleStatus_" + idx).html("<i style=\"color: #6136b1\" class=\"fa fa-spinner fa-spin\" />");
        sendCommand("module disable " + module);
        setTimeout(function() { doQuery(); }, 1000);
    }

    // Import the HTML file for this panel.
    $("#modulesPanel").load("/panel/modules.html");

    // Load the DB items for this panel, wait to ensure that we are connected.
    var interval = setInterval(function() {
        var active = $("#tabs").tabs("option", "active");
        if (active == 1 && isConnected) {
            doQuery();
            clearInterval(interval); 
        }
    }, 200);

    // Query the DB every 30 seconds for updates.
    setInterval(function() {
        var active = $("#tabs").tabs("option", "active");
        if (active == 1 && isConnected) {
            newPanelAlert('Refreshing Modules Data', 'success', 1000);
            doQuery();
        }
    }, 3e4);

    // Export functions - Needed when calling from HTML.
    $.modulesOnMessage = onMessage;
    $.enableModule = enableModule;
    $.disableModule = disableModule;
})();
