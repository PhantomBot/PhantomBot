/*
 * Copyright (C) 2017 phantombot.tv
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */

/* 
 * @author IllusionaryOne
 */

/*
 * cooldownPanel.js
 * Drives the Cooldown Panel
 */
(function() {

    var toggleIcon = [];
        toggleIcon['false'] = "<i class=\"fa fa-circle-o\" />";
        toggleIcon['true'] = "<i class=\"fa fa-circle\" />";

    /*
     * onMessage
     * This event is generated by the connection (WebSocket) object.
     */
    function onMessage(message) {
        var msgObject;

        try {
           msgObject = JSON.parse(message.data);
        } catch (ex) {
            return;
        }

        // Check for dbkeysresult queries
        if (panelHasQuery(msgObject)) {
            var command = "",
                time = "",
                globalCooldown = "",
                globalCooldownTime = "",
                perUserCooldown = "",
                modCooldown = "",
                html = "",
                foundData = false;

            if (panelCheckQuery(msgObject, 'cooldown_cooldowns')) {
                html = "<table>";
                for (idx in msgObject['results']) {
                    command = msgObject['results'][idx]['key'];
                    time = msgObject['results'][idx]['value'];

                    if (panelMatch(command, 'globalCooldown')) {
                        globalCooldown = msgObject['results'][idx]['value'];
                        continue;
                    }
                    if (panelMatch(command, 'globalCooldownTime')) {
                        globalCooldownTime = msgObject['results'][idx]['value'];
                        continue;
                    }
                    if (panelMatch(command, 'modCooldown')) {
                        modCooldown = msgObject['results'][idx]['value'];
                        continue;
                    }
                    if (panelMatch(command, 'perUserCooldown')) {
                        perUserCooldown  = msgObject['results'][idx]['value'];
                        continue;
                    }

                    foundData = true;
                    html += "<tr class=\"textList\">" +
                            "    <td style=\"width: 15px\">" +
                            "        <div id=\"deleteCooldown_" + command + "\" class=\"button\" " +
                            "             onclick=\"$.deleteCooldown('" + command + "')\"><i class=\"fa fa-trash\" />" +
                            "    </td>" + 
                            "    <td>" + command + "</td>" +
                            "    <td>" + time + "</td>" +
                            "</tr>";
                }
                html += "</table>";

                if (!foundData) {
                    html = "<i>No entries in cooldown table.</i>";
                }
                $("#cooldownList").html(html);
    
                $("#toggleGlobalCooldown").html(toggleIcon[globalCooldown]);
                $("#togglePerUserCooldown").html(toggleIcon[perUserCooldown]);
                $("#toggleModCooldown").html(toggleIcon[modCooldown]);
            }
        }
    }

    /**
     * @function doQuery
     */
    function doQuery() {
        sendDBKeys("cooldown_cooldowns", "cooldown");
    }

    /**
     * @function toggleGlobalCooldown
     */
    function toggleGlobalCooldown() {
        $("#toggleGlobalCooldown").html("<i style=\"color: #6136b1\" class=\"fa fa-spinner fa-spin\" />");
        sendCommand("toggleglobalcooldown");
        setTimeout(function() { doQuery(); }, 500);
    }

    /**
     * @function toggleModCooldown
     */
    function toggleModCooldown() {
        $("#toggleModCooldown").html("<i style=\"color: #6136b1\" class=\"fa fa-spinner fa-spin\" />");
        sendCommand("togglemodcooldown");
        setTimeout(function() { doQuery(); }, 500);
    }

    /**
     * @function togglePerUserCooldown
     */
    function togglePerUserCooldown() {
        $("#togglePerUserCooldown").html("<i style=\"color: #6136b1\" class=\"fa fa-spinner fa-spin\" />");
        sendCommand("toggleperusercooldown");
        setTimeout(function() { doQuery(); }, 500);
    }


    /**
     * @function setGlobalCooldownTime
     */
    function setGlobalCooldownTime() {
        var newValue = $("#globalCooldownTimeInput").val();
        if (newValue.length > 0) {
            sendCommand("globalcooldowntime " + newValue);
            $("#globalCooldownTimeInput").val('');
            $("#globalCooldownTimeInput").attr('placeholder', newValue).blur();
        }
    }

    /**
     * @function deleteCooldown
     * @param {String} command
     */
    function deleteCooldown(command) {
        $("#deleteCooldown_" + command).html("<i style=\"color: #6136b1\" class=\"fa fa-spinner fa-spin\" />");
        sendCommand("cooldown " + command + " -1");
        setTimeout(function() { doQuery(); }, 500);
    }

    /**
     * @function addCooldown
     */
    function addCooldown() {
        var input = $("#cooldownCmdInput").val();
        if (input.length > 0) {
            sendCommand("cooldown " + input);
            $("#cooldownCmdInput").val("Submitted");
            setTimeout(function() { $("#cooldownCmdInput").val(""); doQuery(); }, 1000);
        }
    }

    // Import the HTML file for this panel.
    $("#cooldownPanel").load("/panel/cooldown.html");

    // Load the DB items for this panel, wait to ensure that we are connected.
    var interval = setInterval(function() {
        var active = $("#tabs").tabs("option", "active");
        if (active == 4 && isConnected) {
            doQuery();
            clearInterval(interval); 
        }
    }, 200);

    // Query the DB every 30 seconds for updates.
    setInterval(function() {
        var active = $("#tabs").tabs("option", "active");
        if (active == 4 && isConnected && !isInputFocus()) {
            newPanelAlert('Refreshing Cooldown Data', 'success', 1000);
            doQuery();
        }
    }, 3e4);

    // Export functions - Needed when calling from HTML.
    $.cooldownOnMessage = onMessage;
    $.cooldownDoQuery = doQuery;
    $.addCooldown = addCooldown;
    $.deleteCooldown = deleteCooldown;
    $.toggleGlobalCooldown = toggleGlobalCooldown;
    $.toggleModCooldown = toggleModCooldown;
    $.togglePerUserCooldown = togglePerUserCooldown;
    $.setGlobalCooldownTime = setGlobalCooldownTime;
})();
